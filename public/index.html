<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Zcash Radio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{height:100%;margin:0;background:#0b0e13;color:#e8eef5;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
  #player{position:relative}
  #yt{position:absolute;inset:0;width:100%;height:100%}
  footer{padding:.5rem .75rem;font-size:.9rem;color:#9fb0c6;background:linear-gradient(to top,rgba(0,0,0,.5),rgba(0,0,0,0));display:flex;flex-direction:column;align-items:center;gap:.5rem}
  footer .f-left,footer .f-center,footer .f-right{text-align:center}
  footer .f-center{display:flex;gap:1rem;justify-content:center}
  footer button{background:none;border:0;padding:0;font:inherit;color:inherit;cursor:pointer}
  @media(min-width:600px){footer{flex-direction:row;justify-content:space-between}footer .f-left,footer .f-center,footer .f-right{flex:1}footer .f-left{text-align:left}footer .f-right{text-align:right}}
  code{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,.08);border-radius:999px;padding:.2rem .5rem;color:#e8eef5}
  </style>
</head>
<body>
<div id="wrap">
  <div id="player">
    <div id="yt"></div>
  </div>
  <footer>
    <div class="f-left"><span id="status"></span></div>
    <div class="f-center">
      <a id="share" href="#">Share</a>
    </div>
    <div class="f-right">
      <button id="ua-btn"><code id="ua"></code></button>
    </div>
  </footer>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // --- config ---------------------------------------------------------------
  const LIST_URL = "./videos.json"; // same folder as this file
  const DEFAULT_UA = "u147vgjkzaf83ehp6d9qrrwenyjdl8vqz2vm95003txvalhnwa4dk3puzrfxxrnk8r9yws3hqmfqy8060kdxu7vnltfgd3xtdmkp24tgs4j79vgt0fxm5dnv49qh5xtddhgwvukwj90wjerpw3x5uztevptgvvjtezhkjz9sughqy3qv2x";
  const params = new URLSearchParams(location.search);
  const fullUA = params.get("ua") || params.get("addr") || DEFAULT_UA;
  const shorten = s => s.length > 16 ? `${s.slice(0,8)}…${s.slice(-8)}` : s;
  const $uaBtn = document.getElementById("ua-btn");
  $uaBtn.querySelector("code").textContent = shorten(fullUA);
  $uaBtn.addEventListener("click", () => navigator.clipboard.writeText(fullUA));

  // --- state ----------------------------------------------------------------
  let YTPlayer = null;
  let ids = [];
  let order = [];
  let i = 0;
  const re = /^[A-Za-z0-9_-]{11}$/;

  // Promise that resolves when the YouTube player is ready
  let resolveReady;
  const playerReady = new Promise(res => resolveReady = res);


  // --- utils ----------------------------------------------------------------
  const shuffle = a => { for (let j=a.length-1;j>0;j--){const k=(Math.random()*(j+1))|0; [a[j],a[k]]=[a[k],a[j]];} return a; };
  const current = () => order.length ? ids[order[i]] : null;
  const next = () => { if(!order.length) return; i = (i+1)%order.length; play(); };
  const prev = () => { if(!order.length) return; i = (i-1+order.length)%order.length; play(); };

  async function loadIds() {
    const r = await fetch(LIST_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`Failed to load ${LIST_URL} (${r.status})`);
    const j = await r.json();
    ids = Array.isArray(j) ? j.map(v => typeof v === "string" ? v : v.video_id)
                           : Object.keys(j);
    ids = ids.filter(v => re.test(v));
    if (!ids.length) throw new Error("No valid video IDs in videos.json");
    const hash = location.hash.slice(1);
    const idx = ids.indexOf(hash);
    order = shuffle([...ids.keys()]);
    i = idx >= 0 ? order.indexOf(idx) : 0;
  }

  function play() {
    const id = current();
    if (!id) return;
    console.log("Playing " + id);
    location.hash = id;
    YTPlayer.loadVideoById({ videoId: id, suggestedQuality: "large" });
  }

  // YouTube API hook
  window.onYouTubeIframeAPIReady = () => {
    YTPlayer = new YT.Player("yt", {
      width:"100%", height:"100%",
      playerVars:{autoplay:1,controls:0,modestbranding:1,rel:0,playsinline:1,iv_load_policy:3,disablekb:1},
      events:{
        onReady: () => { console.log("Ready"); resolveReady(); },
        onStateChange: e => {
          if (e.data === YT.PlayerState.ENDED) next();
          else if (e.data === YT.PlayerState.PLAYING) console.log("Playing");
          else if (e.data === YT.PlayerState.PAUSED) console.log("Paused");
        },
        onError: () => { console.log("Error • skipping"); next(); }
      }
    });
  };

  // Autoplay first video when ready
  (async () => {
    try {
      await Promise.all([loadIds(), playerReady]);
      YTPlayer.unMute?.();
      play();
    } catch (e) {
      console.log(String(e));
    }
  })();

  const share = () => {
    const id = current();
    if (!id) return;
    const url = location.origin + location.pathname + "#" + id;
    navigator.clipboard.writeText(url).catch(()=>{});
  };
  document.getElementById("share").addEventListener("click", e => { e.preventDefault(); share(); });

  // Keyboard: space = play/pause, arrows = prev/next
  addEventListener("keydown", e => {
    if (!YTPlayer) return;
    if (e.code === "Space") {
      e.preventDefault();
      const s = YTPlayer.getPlayerState?.();
      (s === YT.PlayerState.PLAYING ? YTPlayer.pauseVideo() : YTPlayer.playVideo());
    } else if (e.code === "ArrowRight") { e.preventDefault(); next(); }
    else if (e.code === "ArrowLeft") { e.preventDefault(); prev(); }
  });

  // Optional: reload list hourly if Actions updates it
  setInterval(() => { loadIds().catch(()=>{}); }, 3600_000);
</script>
</body>
</html>

