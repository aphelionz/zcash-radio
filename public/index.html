<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Zcash Radio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  *,*::before,*::after { box-sizing: border-box; }
  :root { --gutter: .75rem; --seam-gap: 10px; --qr-col: clamp(10rem, 18vw, 15%); }
  a, button { color: #f5a623; }
  .orange { color: #f5a623; }
  a, button { touch-action: manipulation; }
  html,body{height:100%;margin:0;background:#0b0e13;color:#e8eef5;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow-x:hidden}
  #wrap{display:grid;grid-template-rows:auto minmax(0, 1fr) auto;margin: auto; gap: var(--gutter); min-height: 100dvh; padding: var(--gutter); }
  header { display: flex; align-items: center; justify-content: space-between; gap: var(--gutter); }
  header h1 { font-size: clamp(1.25rem, 4vw, 2.25rem); margin: 0; flex: 0 0 auto; }
  header marquee { font-size:0.9rem; color:#9fb0c6; flex: 1 1 auto; min-width: 0; max-width: 50%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-family: monospace; }
  main { display: grid; grid-template-columns: minmax(0,1fr) 1px var(--qr-col); gap: 0; min-height: 0; border: 1px solid orange; box-shadow: 0 4px 8px rgba(0,0,0,.3); }
  .separator{ background: orange; }
  #boxes { display: flex; flex-direction: column; padding: var(--gutter) var(--gutter) var(--seam-gap); align-items:flex-end; justify-content: space-between; }
  #player { min-width: 0; min-height: 0; display: flex; flex-direction: column; z-index: 0; justify-content: space-between; }
  #yt{ width:100%; height:80vh; min-width:0; min-height:0; }
  #stats{ display:grid; grid-template-columns: auto 1fr; column-gap:.5rem; row-gap:.25rem; width:100%; font-variant-numeric: tabular-nums; }
  #stats dt{ justify-self:start; margin:0; opacity:.85; }
  #stats dd{ justify-self:end; margin:0; }
  #qrWrap{ position:relative; }
  #copyAddr{ cursor:pointer; }
  #copiedToast{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.85); color:#fff; padding:.35rem .75rem; border-radius:.35rem; font-size:.8rem; pointer-events:none; white-space:nowrap; }
  footer{ padding: .5rem .75rem var(--seam-gap); font-size:.9rem; color:#9fb0c6; display: flex; align-items: flex-end; background:linear-gradient(to top,rgba(0,0,0,.5),rgba(0,0,0,0)); white-space:nowrap; }
  footer a, footer button{white-space:nowrap;}
  #source-link{text-align:left;flex:0 0 auto;}
  #supportLink{text-align:right;flex:0 0 auto;}
  #nextLink{text-align: left; margin:0;flex:1;background:none;border:none;padding:0;font:inherit;cursor:pointer;}
  @media (max-width:480px){footer{font-size:.8rem}}

  /* --- Mobile: stack rows; right column becomes a horizontal bar --- */
  @media (max-width: 720px){
    :root{ --qr-col: clamp(9rem, 28vw, 12rem); }
    main{ grid-template-columns: 1fr; grid-template-rows: auto 1px auto;
          grid-template-areas:
            "player"
            "sep"
            "boxes";
        }

    #boxes{ flex-direction: row; align-items: center; justify-content: space-between; gap: var(--gutter); padding: .5rem var(--gutter); min-width: 0; }
    #stats{ display:flex; flex-wrap:wrap; gap:.5rem 1rem; margin:0; font-size:0.75rem; flex:1 1 60%; min-width:0; }
    #stats dt{ margin:0; opacity:.85; white-space:nowrap; }
    #stats dd{ margin:0; white-space:nowrap; }
    #boxes img#copyAddr{ inline-size: var(--qr-col); block-size: var(--qr-col); flex: 0 0 auto; }
    #yt{ height: auto; aspect-ratio: 16 / 9; }
  }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1><span class="orange">Zcash</span> Radio</h1>
    <marquee behavior="scroll" direction="left" scrollamount="3"> ▶️ Submit tracks in the <a href="https://forum.zcashcommunity.com/t/what-are-you-listening-to/20456" target="_blank" rel="noopener" style="color:#f5a623;">What are you listening to?</a> thread.</marquee>
  </header>
  <main>
    <div id="player">
      <div id="yt"></div>
      <footer>
        <button id="nextLink" type="button" onclick="next()" title="Play next song">Next ►</button>
        <a id="source-link" target="_blank" rel="noopener"></a>
      </footer>
    </div>
    <div class="separator" aria-hidden="true"></div>
    <div id="boxes">
      <dl id="stats">
        <dt>Height:</dt> <dd id="blockHeight"></dd>
        <dt>USD/ZEC:</dt> <dd id="USDZEC"></dd>
        <dt>mBTC/ZEC:</dt> <dd id="BTCZEC"></dd>
        <dt>CMC Rank:</dt> <dd id="ZECRank"></dd>
      </dl>
      <div id="qrWrap"><img id="copyAddr" role="button" tabindex="0" width="150" src="ZEC_QR.jpeg" alt="Zcash tip QR code, activate to copy address" aria-label="Copy Zcash tip address" title="Copy Zcash tip address" referrerpolicy="no-referrer"><div id="copiedToast" hidden aria-live="polite">copied to clipboard</div></div>
    </div>
  </main>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // --- constants / config ---------------------------------------------------
  const LIST_URL = "./videos.json"; // same folder as this file
  const DEFAULT_ADDR = "u147vgjkzaf83ehp6d9qrrwenyjdl8vqz2vm95003txvalhnwa4dk3puzrfxxrnk8r9yws3hqmfqy8060kdxu7vnltfgd3xtdmkp24tgs4j79vgt0fxm5dnv49qh5xtddhgwvukwj90wjerpw3x5uztevptgvvjtezhkjz9sughqy3qv2x";
  const DEFAULT_QR_SRC = "ZEC_QR.jpeg";
  const TIP_URI_PREFIX = "zcash:";
  const QR_SERVICE_BASE = "https://api.qrserver.com/v1/create-qr-code/?format=svg&size=150x150&data=";
  const DEFAULT_QR_ALT = "Zcash tip QR code, activate to copy address";

  const $copyAddr = document.getElementById("copyAddr");
  const $toast = document.getElementById("copiedToast");
  let toastTimer = null;
  let activeAddress = DEFAULT_ADDR;
  let lastQrSrc = DEFAULT_QR_SRC;

  function showToast(message = "copied to clipboard") {
    if (toastTimer) {
      clearTimeout(toastTimer);
      toastTimer = null;
    }
    if (message) $toast.textContent = message;
    $toast.hidden = false;
    toastTimer = setTimeout(() => {
      $toast.hidden = true;
      toastTimer = null;
    }, 1200);
  }

  async function copyAddress() {
    if (!navigator.clipboard || typeof navigator.clipboard.writeText !== "function") {
      console.error("Clipboard API is not available in this browser");
      showToast("copy failed");
      return;
    }
    try {
      await navigator.clipboard.writeText(activeAddress);
      showToast();
    } catch (err) {
      console.error("Failed to copy address", err);
      showToast("copy failed");
    }
  }

  const addressFromMeta = info => {
    if (!info || typeof info !== "object") return null;
    return info.tip_zcash_uri || info.tip_uri || info.tip_unified_address || info.tip_address || info.tip_zaddr || info.tip_z_address || null;
  };

  const normalizeTipValue = raw => {
    if (typeof raw !== "string") return null;
    const trimmed = raw.trim();
    if (!trimmed) return null;
    const colonIdx = trimmed.indexOf(":");
    if (colonIdx > 0 && colonIdx <= 10) {
      const scheme = trimmed.slice(0, colonIdx).toLowerCase();
      if (scheme !== "zcash" && scheme !== "zaddr") return null;
      let rest = trimmed.slice(colonIdx + 1);
      if (rest.startsWith("//")) rest = rest.slice(2);
      const queryIdx = rest.search(/[?#]/);
      const addrPart = queryIdx >= 0 ? rest.slice(0, queryIdx) : rest;
      const suffix = queryIdx >= 0 ? rest.slice(queryIdx) : "";
      const cleaned = (addrPart || "").trim();
      if (!cleaned) return null;
      const uri = `${scheme}:${cleaned}${suffix}`;
      return {
        address: cleaned,
        uri
      };
    }
    return {
      address: trimmed,
      uri: `${TIP_URI_PREFIX}${trimmed}`
    };
  };

  function updateTip(info) {
    const tip = normalizeTipValue(addressFromMeta(info));
    const nextAddress = tip ? tip.address : DEFAULT_ADDR;
    const nextUri = tip ? tip.uri : `${TIP_URI_PREFIX}${DEFAULT_ADDR}`;

    activeAddress = nextAddress;
    if (tip) {
      const qrSrc = `${QR_SERVICE_BASE}${encodeURIComponent(nextUri)}`;
      if (lastQrSrc !== qrSrc) {
        $copyAddr.src = qrSrc;
        lastQrSrc = qrSrc;
      }
      const labelName = info && info.username ? `@${info.username}` : "this curator";
      $copyAddr.alt = `Send a Zcash tip to ${labelName}. Activate to copy address.`;
      $copyAddr.setAttribute("aria-label", `Copy Zcash tip address for ${labelName}`);
      $copyAddr.title = `Copy ${labelName}'s Zcash tip address`;
    } else {
      if (lastQrSrc !== DEFAULT_QR_SRC) {
        $copyAddr.src = DEFAULT_QR_SRC;
        lastQrSrc = DEFAULT_QR_SRC;
      }
      $copyAddr.alt = DEFAULT_QR_ALT;
      $copyAddr.setAttribute("aria-label", "Copy Zcash tip address");
      $copyAddr.title = "Copy Zcash tip address";
    }
  }

  $copyAddr.addEventListener("click", copyAddress);
  $copyAddr.addEventListener("keydown", e => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      copyAddress();
    }
  });

  // --- state ----------------------------------------------------------------
  let YTPlayer = null;
  let ids = [];
  let order = [];
  let meta = {};
  let i = 0;
  const re = /^[A-Za-z0-9_-]{11}$/;
  const $src = document.getElementById("source-link");

  // Promise that resolves when the YouTube player is ready
  let resolveReady;
  const playerReady = new Promise(res => resolveReady = res);


  // --- utils ----------------------------------------------------------------
  const shuffle = a => { for (let j=a.length-1;j>0;j--){const k=(Math.random()*(j+1))|0; [a[j],a[k]]=[a[k],a[j]];} return a; };
  const current = () => order.length ? ids[order[i]] : null;
  const next = () => { if(!order.length) return; i = (i+1)%order.length; play(); };
  const prev = () => { if(!order.length) return; i = (i-1+order.length)%order.length; play(); };

  const nfUSD = new Intl.NumberFormat("en-US", { style:"currency", currency:"USD", maximumFractionDigits: 2 });
  const nfMilliBTC = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  async function loadIds() {
    const r = await fetch(LIST_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`Failed to load ${LIST_URL} (${r.status})`);
    const j = await r.json();
    if (Array.isArray(j)) {
      meta = {};
      ids = j.map(v => typeof v === "string" ? v : v.video_id);
    } else {
      meta = j;
      ids = Object.keys(j);
    }
    ids = ids.filter(v => re.test(v));
    if (!ids.length) throw new Error("No valid video IDs in videos.json");
    const hash = location.hash.slice(1);
    const idx = ids.indexOf(hash);
    order = shuffle([...ids.keys()]);
    i = idx >= 0 ? order.indexOf(idx) : 0;
  }

  function play() {
    const id = current();
    if (!id) return;
    location.hash = id;
    const info = meta[id];
    updateTip(info);
    if (info && info.source_post_url) {
      $src.href = info.source_post_url;
      $src.textContent = info.username ? `Posted by @${info.username}` : "Posted by source";
      $src.style.visibility = "visible";
    } else {
      $src.removeAttribute("href");
      $src.textContent = "";
      $src.style.visibility = "hidden";
    }
    YTPlayer.loadVideoById({ videoId: id, suggestedQuality: "large" });
  }

  // YouTube API hook
  window.onYouTubeIframeAPIReady = () => {
    YTPlayer = new YT.Player("yt", {
      width:"", height:"100%",
      playerVars:{autoplay:1,controls:0,modestbranding:1,rel:0,playsinline:1,iv_load_policy:3,disablekb:1},
      events:{
        onReady: () => { console.log("Ready"); resolveReady(); },
        onStateChange: e => {
          if (e.data === YT.PlayerState.ENDED) next();
        },
        onError: () => { console.log(`Error • skipping ${current() || 'unknown track'}`); next(); }
      }
    });
  };

  async function getZecStats() {
    try {
      const res = await fetch('./data/zec-stats.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      const json = await res.json();
      return {
        height: json?.height ?? null,
        usd_zec: json?.usd_zec ?? null,
        btc_zec: json?.btc_zec ?? null,
        rank: json?.rank ?? null,
        market_cap_usd: json?.market_cap_usd ?? null,
        mbtc_usd: json?.mbtc_usd ?? null
      }
    } catch (e) {
      console.error("Failed to fetch ZEC stats:", e);
      return {
        height: null,
        usd_zec: null,
        btc_zec: null,
        rank: null,
        market_cap_usd: null,
        mbtc_usd: null
      };
    }
  }

  async function updateStats() {
    try {
      const stats = await getZecStats();
      const rankElement = document.getElementById("ZECRank");
      const rankValue = stats.rank !== null ? Number(stats.rank) : null;
      rankElement.textContent = Number.isFinite(rankValue) ? `#${Math.round(rankValue)}` : "N/A";

      document.getElementById("blockHeight").textContent = stats.height !== null ? stats.height : "N/A";
      const usdElement = document.getElementById("USDZEC");
      const usdPrice = stats.usd_zec !== null ? Number(stats.usd_zec) : null;
      usdElement.textContent = Number.isFinite(usdPrice) ? nfUSD.format(usdPrice) : "N/A";

      const btcElement = document.getElementById("BTCZEC");
      const btcPrice = stats.btc_zec !== null ? Number(stats.btc_zec) : null;
      if (Number.isFinite(btcPrice)) {
        const mBtcValue = btcPrice * 1000;
        btcElement.textContent = nfMilliBTC.format(mBtcValue);
      } else {
        btcElement.textContent = "N/A";
      }
    } catch (e) {
      console.error("Failed to update stats:", e);
      document.getElementById("ZECRank").textContent = "N/A";
      document.getElementById("blockHeight").textContent = "N/A";
      document.getElementById("USDZEC").textContent = "N/A";
      document.getElementById("BTCZEC").textContent = "N/A";
    }
  }

  setInterval(updateStats, 60000);
  updateStats();

  // Autoplay first video when ready
  (async () => {
    try {
      await Promise.all([loadIds(), playerReady]);
      YTPlayer.unMute?.();
      play();
    } catch (e) {
      console.log(String(e));
    }
  })();

  // Keyboard: space = play/pause, arrows = prev/next
  addEventListener("keydown", e => {
    if (!YTPlayer) return;
    if (e.code === "Space") {
      e.preventDefault();
      const s = YTPlayer.getPlayerState?.();
      (s === YT.PlayerState.PLAYING ? YTPlayer.pauseVideo() : YTPlayer.playVideo());
    } else if (e.code === "ArrowRight") { e.preventDefault(); next(); }
    else if (e.code === "ArrowLeft") { e.preventDefault(); prev(); }
  });

  // Optional: reload list hourly if Actions updates it
  setInterval(() => { loadIds().catch(()=>{}); }, 3600_000);
</script>
</body>
</html>
