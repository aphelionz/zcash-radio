<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>üÖ©üÖö Radio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  *,*::before,*::after { box-sizing: border-box; }
  :root { --gutter: .75rem; --seam-gap: 10px; --qr-col: clamp(10rem, 18vw, 15%); }
  a, .orange { color: #f5a623; }
  html,body{height:100%;margin:0;background:#0b0e13;color:#e8eef5;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow-x:hidden}
  #wrap{display:grid;grid-template-rows:auto minmax(0, 1fr) auto;margin: auto; gap: var(--gutter); min-height: 100dvh; padding: var(--gutter); }
  header { display: flex; align-items: center; justify-content: space-between; gap: var(--gutter); }
  header h1 { margin: 0; flex: 0 0 auto; }
  header marquee { flex: 1 1 auto; min-width: 0; max-width: 50%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-family: monospace; }
  main { display: grid; grid-template-columns: minmax(0,1fr) 1px var(--qr-col); gap: 0; min-height: 0; border: 1px solid orange; box-shadow: 0 4px 8px rgba(0,0,0,.3); }
  .separator{ background: orange; }
  #boxes { display: flex; flex-direction: column; padding: var(--gutter) var(--gutter) var(--seam-gap); align-items:flex-end; justify-content: space-between; }
  #player { min-width: 0; min-height: 0; display: flex; flex-direction: column; z-index: 0; justify-content: space-between; }
  #yt{ width:100%; height:80vh; aspect-ratio: 16/9; min-width:0; min-height:0; }
  #stats{ display:grid; grid-template-columns: auto 1fr; column-gap:.5rem; row-gap:.25rem; width:100%; font-variant-numeric: tabular-nums; }
  #stats dt{ justify-self:start; margin:0; opacity:.85; }
  #stats dd{ justify-self:end; margin:0; }
  footer{ padding: .5rem .75rem var(--seam-gap); font-size:.9rem; color:#9fb0c6; display: flex; align-items: flex-end; background:linear-gradient(to top,rgba(0,0,0,.5),rgba(0,0,0,0)); white-space:nowrap; }
  footer a{white-space:nowrap;}
  #source-link{text-align:left;flex:0 0 auto;}
  #supportLink{text-align:right;flex:0 0 auto;}
  #nextLink{margin:0;flex:1;}
  @media (max-width:480px){footer{font-size:.8rem}}

  /* --- Mobile: stack rows; right column becomes a horizontal bar --- */
  @media (max-width: 720px){
    :root{ --qr-col: clamp(9rem, 28vw, 12rem); }
    main{ grid-template-columns: 1fr; grid-template-rows: auto 1px auto;
          grid-template-areas:
            "player"
            "sep"
            "boxes";
        }

    #boxes{ flex-direction: row; align-items: center; justify-content: space-between; gap: var(--gutter); padding: .5rem var(--gutter); min-width: 0; }
    #stats{ gap: .5rem 1rem; margin: 0; max-width: 40%; font-size: 0.75rem; }
    #stats dt{ margin:0; opacity:.85; white-space:nowrap;}
    #stats dd{ margin:0; }
    #boxes img#copyAddr{ inline-size: var(--qr-col); block-size: var(--qr-col); flex: 0 0 auto; }
    #yt{ height: auto; aspect-ratio: 16 / 9; }
  }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1><span class="orange">üÖ©üÖö</span> Radio</h1>
    <marquee behavior="scroll" direction="left" scrollamount="3" style="font-size:0.9rem;color:#9fb0c6;"> ‚ñ∂Ô∏è Submit tracks in the <a href="https://forum.zcashcommunity.com/t/what-are-you-listening-to/20456" target="_blank" rel="noopener" style="color:#f5a623;">What are you listening to?</a> thread. (Subject to <a href="X" target="_blank" rel="noopener" style="color:#f5a623;">curation</a>.) </marquee>
  </header>
  <main>
    <div id="player">
      <div id="yt"></div>
      <footer>
        <a id="nextLink" href="#" onclick="next();return false;" title="Play next song">Next ‚ñ∫</a>
        <a id="source-link" target="_blank" rel="noopener"></a>
      </footer>
    </div>
    <div class="separator" aria-hidden="true"></div>
    <div id="boxes">
      <dl id="stats">
        <dt>Block height:</dt> <dd id="blockHeight"></dd>
        <dt>USD/ZEC:</dt> <dd id="USDZEC"></dd>
        <dt>BTC/ZEC</dt> <dd id="BTCZEC"></dd>
      </dl>
      <div><img id="copyAddr" width=150 src="ZEC_QR.jpeg" alt="Zcash QR"></div>
    </div>
  </main>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // --- constants / config ---------------------------------------------------
  const LIST_URL = "./videos.json"; // same folder as this file
  const ADDR = "u147vgjkzaf83ehp6d9qrrwenyjdl8vqz2vm95003txvalhnwa4dk3puzrfxxrnk8r9yws3hqmfqy8060kdxu7vnltfgd3xtdmkp24tgs4j79vgt0fxm5dnv49qh5xtddhgwvukwj90wjerpw3x5uztevptgvvjtezhkjz9sughqy3qv2x";

  document.getElementById("copyAddr").addEventListener("click", () => {
    navigator.clipboard.writeText(ADDR).then(() => {
      const s = document.getElementById("copyStatus");
      s.style.display = "inline";
      setTimeout(() => { s.style.display = "none"; }, 1500);
    });
  });

  // --- state ----------------------------------------------------------------
  let YTPlayer = null;
  let ids = [];
  let order = [];
  let meta = {};
  let i = 0;
  const re = /^[A-Za-z0-9_-]{11}$/;
  const $src = document.getElementById("source-link");

  // Promise that resolves when the YouTube player is ready
  let resolveReady;
  const playerReady = new Promise(res => resolveReady = res);


  // --- utils ----------------------------------------------------------------
  const shuffle = a => { for (let j=a.length-1;j>0;j--){const k=(Math.random()*(j+1))|0; [a[j],a[k]]=[a[k],a[j]];} return a; };
  const current = () => order.length ? ids[order[i]] : null;
  const next = () => { if(!order.length) return; i = (i+1)%order.length; play(); };
  const prev = () => { if(!order.length) return; i = (i-1+order.length)%order.length; play(); };

  const nfUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits: 2 });
  const nfBTC = new Intl.NumberFormat('en-US', { maximumSignificantDigits: 6 });

  async function loadIds() {
    const r = await fetch(LIST_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`Failed to load ${LIST_URL} (${r.status})`);
    const j = await r.json();
    if (Array.isArray(j)) {
      meta = {};
      ids = j.map(v => typeof v === "string" ? v : v.video_id);
    } else {
      meta = j;
      ids = Object.keys(j);
    }
    ids = ids.filter(v => re.test(v));
    if (!ids.length) throw new Error("No valid video IDs in videos.json");
    const hash = location.hash.slice(1);
    const idx = ids.indexOf(hash);
    order = shuffle([...ids.keys()]);
    i = idx >= 0 ? order.indexOf(idx) : 0;
  }

  function play() {
    const id = current();
    if (!id) return;
    location.hash = id;
    const info = meta[id];
    if (info && info.source_post_url) {
      $src.href = info.source_post_url;
      $src.textContent = info.username ? `Posted by @${info.username}` : "Posted by source";
      $src.style.visibility = "visible";
    } else {
      $src.removeAttribute("href");
      $src.textContent = "";
      $src.style.visibility = "hidden";
    }
    YTPlayer.loadVideoById({ videoId: id, suggestedQuality: "large" });
  }

  // YouTube API hook
  window.onYouTubeIframeAPIReady = () => {
    YTPlayer = new YT.Player("yt", {
      width:"", height:"100%",
      playerVars:{autoplay:1,controls:0,modestbranding:1,rel:0,playsinline:1,iv_load_policy:3,disablekb:1},
      events:{
        onReady: () => { console.log("Ready"); resolveReady(); },
        onStateChange: e => {
          if (e.data === YT.PlayerState.ENDED) next();
        },
        onError: () => { console.log(`Error ‚Ä¢ skipping ${current() || 'unknown track'}`); next(); }
      }
    });
  };

  async function getZecStats() {
    const res = await fetch('https://api.blockchair.com/zcash/stats');
    const json = await res.json();
    // Height lives here on current API; keep a fallback for safety:
    return {
      height: json?.data?.best_block_height ?? json?.data?.blocks ?? null,
      usd_zec: json?.data?.market_price_usd ?? null,
      btc_zec: json?.data?.market_price_btc ?? null
    }
  }

  async function updateStats() {
    const stats = await getZecStats();
    document.getElementById("blockHeight").textContent = stats.height !== null ? stats.height : "N/A";
    document.getElementById("USDZEC").textContent = stats.usd_zec !== null ? nfUSD.format(stats.usd_zec) : "N/A";
    document.getElementById("BTCZEC").textContent = stats.btc_zec !== null ? nfBTC.format(stats.btc_zec) : "N/A";
  }

  setInterval(updateStats, 60000);
  updateStats();

  // Autoplay first video when ready
  (async () => {
    try {
      await Promise.all([loadIds(), playerReady]);
      YTPlayer.unMute?.();
      play();
    } catch (e) {
      console.log(String(e));
    }
  })();

  // Keyboard: space = play/pause, arrows = prev/next
  addEventListener("keydown", e => {
    if (!YTPlayer) return;
    if (e.code === "Space") {
      e.preventDefault();
      const s = YTPlayer.getPlayerState?.();
      (s === YT.PlayerState.PLAYING ? YTPlayer.pauseVideo() : YTPlayer.playVideo());
    } else if (e.code === "ArrowRight") { e.preventDefault(); next(); }
    else if (e.code === "ArrowLeft") { e.preventDefault(); prev(); }
  });

  // Optional: reload list hourly if Actions updates it
  setInterval(() => { loadIds().catch(()=>{}); }, 3600_000);
</script>
</body>
</html>

