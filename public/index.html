<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Zcash Radio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{height:100%;margin:0;background:#0b0e13;color:#e8eef5;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow-x:hidden}
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
  #player{position:relative}
  #yt{position:absolute;inset:0;width:100%;height:100%}
  footer{padding:.5rem .75rem;font-size:.9rem;color:#9fb0c6;background:linear-gradient(to top,rgba(0,0,0,.5),rgba(0,0,0,0));display:flex;align-items:center;gap:1rem;white-space:nowrap}
  footer a{color:inherit;text-decoration:none;white-space:nowrap;flex:1;text-align:center}
  #source-link{text-align:left}
  #supportLink{text-align:right}
  #nextLink{margin:0}
  @media (max-width:480px){footer{font-size:.8rem}}
  #supportModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);align-items:center;justify-content:center}
  #supportModal .modal-box{background:#1f2937;padding:1.5rem;border-radius:.5rem;max-width:500px;width:90%;color:#d1d5db;position:relative;text-align:center}
  #supportModal .modal-box a,#supportModal .modal-box button{color:#f5a623}
  #supportModal .close{position:absolute;top:.5rem;right:.5rem;background:none;border:0;font-size:1.5rem;line-height:1;color:#d1d5db;cursor:pointer}
  </style>
</head>
<body>
<div id="wrap">
  <div id="player">
    <div id="yt"></div>
  </div>
  <footer>
    <a id="source-link" target="_blank" rel="noopener"></a>
    <a id="nextLink" href="#" onclick="next();return false;" title="Play next song">Next ►</a>
    <a id="supportLink" href="#">Support zcash.radio</a>
  </footer>
</div>
<div id="supportModal">
  <div class="modal-box">
    <button id="closeModal" class="close">&times;</button>
    <h3>zcash.radio<br /><small>by @aphelionz</small></h3>
    <div><img width=300 src="ZEC_QR.jpeg" alt="Zcash QR"></div>
    <button id="copyAddr">Copy Address</button> <span id="copyStatus" style="display:none;">Copied!</span>
    <p>
      Submit tracks <a href="https://forum.zcashcommunity.com/t/what-are-you-listening-to/20456" target="_blank" rel="noopener">in this thread.</a>
    </p>
    <small>(Subject to <a href="https://github.com/aphelionz/zcash-radio/blob/main/curation.txt">curation</a>).</small>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // --- constants / config ---------------------------------------------------
  const LIST_URL = "./videos.json"; // same folder as this file
  const ADDR = "u147vgjkzaf83ehp6d9qrrwenyjdl8vqz2vm95003txvalhnwa4dk3puzrfxxrnk8r9yws3hqmfqy8060kdxu7vnltfgd3xtdmkp24tgs4j79vgt0fxm5dnv49qh5xtddhgwvukwj90wjerpw3x5uztevptgvvjtezhkjz9sughqy3qv2x";

  document.getElementById("copyAddr").addEventListener("click", () => {
    navigator.clipboard.writeText(ADDR).then(() => {
      const s = document.getElementById("copyStatus");
      s.style.display = "inline";
      setTimeout(() => { s.style.display = "none"; }, 1500);
    });
  });
  const $modal = document.getElementById("supportModal");
  document.getElementById("supportLink").addEventListener("click", e => { e.preventDefault(); $modal.style.display = "flex"; });
  document.getElementById("closeModal").addEventListener("click", () => { $modal.style.display = "none"; });
  $modal.addEventListener("click", e => { if (e.target === $modal) $modal.style.display = "none"; });

  // --- state ----------------------------------------------------------------
  let YTPlayer = null;
  let ids = [];
  let order = [];
  let meta = {};
  let i = 0;
  const re = /^[A-Za-z0-9_-]{11}$/;
  const $src = document.getElementById("source-link");

  // Promise that resolves when the YouTube player is ready
  let resolveReady;
  const playerReady = new Promise(res => resolveReady = res);


  // --- utils ----------------------------------------------------------------
  const shuffle = a => { for (let j=a.length-1;j>0;j--){const k=(Math.random()*(j+1))|0; [a[j],a[k]]=[a[k],a[j]];} return a; };
  const current = () => order.length ? ids[order[i]] : null;
  const next = () => { if(!order.length) return; i = (i+1)%order.length; play(); };
  const prev = () => { if(!order.length) return; i = (i-1+order.length)%order.length; play(); };

  async function loadIds() {
    const r = await fetch(LIST_URL, { cache: "no-store" });
    if (!r.ok) throw new Error(`Failed to load ${LIST_URL} (${r.status})`);
    const j = await r.json();
    if (Array.isArray(j)) {
      meta = {};
      ids = j.map(v => typeof v === "string" ? v : v.video_id);
    } else {
      meta = j;
      ids = Object.keys(j);
    }
    ids = ids.filter(v => re.test(v));
    if (!ids.length) throw new Error("No valid video IDs in videos.json");
    const hash = location.hash.slice(1);
    const idx = ids.indexOf(hash);
    order = shuffle([...ids.keys()]);
    i = idx >= 0 ? order.indexOf(idx) : 0;
  }

  function play() {
    const id = current();
    if (!id) return;
    console.log("Playing " + id);
    location.hash = id;
    const info = meta[id];
    if (info && info.source_post_url) {
      $src.href = info.source_post_url;
      $src.textContent = info.username ? `Posted by @${info.username}` : "Posted by source";
      $src.style.visibility = "visible";
    } else {
      $src.removeAttribute("href");
      $src.textContent = "";
      $src.style.visibility = "hidden";
    }
    YTPlayer.loadVideoById({ videoId: id, suggestedQuality: "large" });
  }

  // YouTube API hook
  window.onYouTubeIframeAPIReady = () => {
    YTPlayer = new YT.Player("yt", {
      width:"100%", height:"100%",
      playerVars:{autoplay:1,controls:0,modestbranding:1,rel:0,playsinline:1,iv_load_policy:3,disablekb:1},
      events:{
        onReady: () => { console.log("Ready"); resolveReady(); },
        onStateChange: e => {
          if (e.data === YT.PlayerState.ENDED) next();
          else if (e.data === YT.PlayerState.PLAYING) console.log("Playing");
          else if (e.data === YT.PlayerState.PAUSED) console.log("Paused");
        },
        onError: () => { console.log("Error • skipping"); next(); }
      }
    });
  };

  // Autoplay first video when ready
  (async () => {
    try {
      await Promise.all([loadIds(), playerReady]);
      YTPlayer.unMute?.();
      play();
    } catch (e) {
      console.log(String(e));
    }
  })();

  // Keyboard: space = play/pause, arrows = prev/next
  addEventListener("keydown", e => {
    if (!YTPlayer) return;
    if (e.code === "Space") {
      e.preventDefault();
      const s = YTPlayer.getPlayerState?.();
      (s === YT.PlayerState.PLAYING ? YTPlayer.pauseVideo() : YTPlayer.playVideo());
    } else if (e.code === "ArrowRight") { e.preventDefault(); next(); }
    else if (e.code === "ArrowLeft") { e.preventDefault(); prev(); }
  });

  // Optional: reload list hourly if Actions updates it
  setInterval(() => { loadIds().catch(()=>{}); }, 3600_000);
</script>
</body>
</html>

